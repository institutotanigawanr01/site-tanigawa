<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årea do Aluno - Instituto Tanigawa</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-blue: #3b82f6; --primary-gold: #f59e0b; --dark-bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.5); --text-light: #e2e8f0; --text-gray: #94a3b8;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: var(--text-light); min-height: 100vh; }
        
        /* HEADER */
        .header { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(59, 130, 246, 0.2); padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #f59e0b); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 800; color: white; }
        h1 { font-family: 'Playfair Display', serif; font-size: 1.5rem; background: linear-gradient(135deg, #3b82f6, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #f59e0b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .btn-logout { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--danger); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.3s; }
        .btn-logout:hover { background: rgba(239, 68, 68, 0.2); }

        /* LAYOUT */
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; }
        .grid-layout { display: grid; grid-template-columns: 350px 1fr; gap: 2rem; }

        /* SIDEBAR */
        .sidebar { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 16px; padding: 1.5rem; height: fit-content; position: sticky; top: 100px; }
        .progress-card { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(245, 158, 11, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .progress-title { font-size: 0.875rem; color: var(--text-gray); margin-bottom: 0.5rem; }
        .progress-value { font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, #3b82f6, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .progress-bar { height: 8px; background: rgba(59, 130, 246, 0.2); border-radius: 999px; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #f59e0b); border-radius: 999px; transition: width 0.3s; }
        
        .module-list { list-style: none; }
        .module-item { margin-bottom: 0.5rem; }
        .module-header { background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; border: 1px solid transparent; }
        .module-header:hover { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); }
        .module-header.active { background: rgba(59, 130, 246, 0.2); border-color: var(--primary-blue); }
        .module-title { font-weight: 600; font-size: 0.875rem; }
        .module-icon { font-size: 0.75rem; transition: transform 0.3s; }
        .module-icon.open { transform: rotate(180deg); }
        
        .lesson-list { list-style: none; padding-left: 1rem; margin-top: 0.5rem; display: none; }
        .lesson-list.show { display: block; }
        .lesson-item { padding: 0.75rem; margin-bottom: 0.25rem; border-radius: 6px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; }
        .lesson-item:hover { background: rgba(59, 130, 246, 0.1); }
        .lesson-item.active { background: rgba(59, 130, 246, 0.2); border-left: 3px solid var(--primary-blue); }
        .lesson-item.completed { color: var(--success); }
        .lesson-icon { font-size: 1rem; }
        .lesson-duration { color: var(--text-gray); font-size: 0.75rem; margin-left: auto; }

        /* MAIN CONTENT */
        .main-content { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 16px; padding: 2rem; }
        .welcome-screen { text-align: center; padding: 4rem 2rem; }
        .welcome-icon { font-size: 4rem; margin-bottom: 1rem; }
        .welcome-title { font-family: 'Playfair Display', serif; font-size: 2rem; margin-bottom: 1rem; background: linear-gradient(135deg, #3b82f6, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .welcome-text { color: var(--text-gray); line-height: 1.6; margin-bottom: 2rem; }

        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; margin-bottom: 2rem; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .video-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-gray); }
        .video-placeholder-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.3; }

        .lesson-info { margin-bottom: 2rem; }
        .lesson-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
        .lesson-title { font-family: 'Playfair Display', serif; font-size: 1.75rem; color: var(--text-light); }
        .lesson-meta { display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-gray); margin-bottom: 1rem; }
        .lesson-meta span { display: flex; align-items: center; gap: 0.5rem; }
        .lesson-description { color: var(--text-gray); line-height: 1.6; }

        .lesson-actions { display: flex; gap: 1rem; padding-top: 2rem; border-top: 1px solid rgba(59, 130, 246, 0.2); }
        .btn-primary { flex: 1; padding: 1rem; background: linear-gradient(135deg, #3b82f6, #f59e0b); border: none; border-radius: 8px; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { flex: 1; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: var(--text-light); font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-secondary:hover { background: rgba(59, 130, 246, 0.2); }

        .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.875rem; }
        .alert-info { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: var(--primary-blue); }
        .alert-success { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: var(--success); }

        @media (max-width: 1024px) {
            .grid-layout { grid-template-columns: 1fr; }
            .sidebar { position: static; }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div class="logo">
            <div class="logo-icon">IT</div>
            <div>
                <h1>√Årea do Aluno</h1>
                <p style="font-size: 0.75rem; color: var(--text-gray);">Instituto Tanigawa</p>
            </div>
        </div>
        <div class="user-info">
            <div>
                <div style="font-size: 0.875rem; font-weight: 600;" id="userName">Carregando...</div>
                <div style="font-size: 0.75rem; color: var(--text-gray);" id="userMentoria">Carregando...</div>
            </div>
            <div class="user-avatar" id="userAvatar">?</div>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container">
        <div class="grid-layout">
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <div class="progress-card">
                    <div class="progress-title">Seu Progresso</div>
                    <div class="progress-value" id="progressPercentage">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-gray);">
                        <span id="completedLessons">0</span> de <span id="totalLessons">0</span> aulas conclu√≠das
                    </div>
                </div>

                <h3 style="font-size: 0.875rem; color: var(--text-gray); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">üìö M√≥dulos</h3>
                <ul class="module-list" id="moduleList">
                    <!-- Modules will be loaded here -->
                </ul>
            </aside>

            <!-- MAIN CONTENT -->
            <main class="main-content">
                <div id="welcomeScreen" class="welcome-screen">
                    <div class="welcome-icon">üéì</div>
                    <h2 class="welcome-title">Bem-vindo √† sua Mentoria!</h2>
                    <p class="welcome-text">
                        Selecione um m√≥dulo na barra lateral para come√ßar sua jornada de transforma√ß√£o.<br>
                        Todas as aulas est√£o organizadas em m√≥dulos progressivos para seu melhor aprendizado.
                    </p>
                    <div style="max-width: 400px; margin: 0 auto; text-align: left;">
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                            <strong style="color: var(--primary-blue);">üí° Dica:</strong> Assista as aulas em ordem para melhor compreens√£o
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px;">
                            <strong style="color: var(--success);">üìπ Grava√ß√µes:</strong> Todas as sess√µes ficam dispon√≠veis por 6 meses
                        </div>
                    </div>
                </div>

                <div id="lessonContent" style="display: none;">
                    <div class="lesson-info">
                        <div class="lesson-header">
                            <div>
                                <h2 class="lesson-title" id="lessonTitle">T√≠tulo da Aula</h2>
                                <div class="lesson-meta">
                                    <span>üìö <span id="lessonModule">M√≥dulo</span></span>
                                    <span>‚è±Ô∏è <span id="lessonDuration">00:00</span></span>
                                    <span>üìπ <span id="lessonVideoId">ID</span></span>
                                </div>
                            </div>
                        </div>
                        <p class="lesson-description" id="lessonDescription">Descri√ß√£o da aula ser√° carregada aqui.</p>
                    </div>

                    <div class="video-container" id="videoContainer">
                        <div class="video-placeholder">
                            <div class="video-placeholder-icon">‚ñ∂Ô∏è</div>
                            <p>Clique em "Iniciar Aula" para come√ßar</p>
                        </div>
                    </div>

                    <div id="alertComplete" class="alert alert-success" style="display: none;">
                        ‚úÖ <strong>Parab√©ns!</strong> Voc√™ marcou esta aula como conclu√≠da.
                    </div>

                    <div class="lesson-actions">
                        <button class="btn-secondary" onclick="previousLesson()" id="btnPrevious">‚¨ÖÔ∏è Aula Anterior</button>
                        <button class="btn-primary" onclick="toggleComplete()" id="btnComplete">‚úÖ Marcar como Conclu√≠da</button>
                        <button class="btn-secondary" onclick="nextLesson()" id="btnNext">Pr√≥xima Aula ‚û°Ô∏è</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // ============================================
        // DADOS E ESTADO
        // ============================================
        let estrutura = null;
        let currentUser = null;
        let currentLesson = null;
        let completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');
        let allLessons = [];

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        window.addEventListener('DOMContentLoaded', async function() {
            await verificarAutenticacao();
            await carregarEstrutura();
            renderizarModulos();
            atualizarProgresso();
        });

        async function verificarAutenticacao() {
            const userType = sessionStorage.getItem('userType');
            const userName = sessionStorage.getItem('userName');
            const userMentoria = sessionStorage.getItem('userMentoria') || 'SYNESIS';

            if (userType !== 'member' && userType !== 'admin') {
                alert('Acesso n√£o autorizado. Fa√ßa login primeiro.');
                window.location.href = 'auth_system.html';
                return;
            }

            currentUser = { name: userName, mentoria: userMentoria };
            
            document.getElementById('userName').textContent = userName || 'Aluno';
            document.getElementById('userMentoria').textContent = userMentoria;
            document.getElementById('userAvatar').textContent = (userName || 'A')[0].toUpperCase();
        }

        async function carregarEstrutura() {
            try {
                const response = await fetch('estrutura.json');
                estrutura = await response.json();
            } catch (error) {
                console.error('Erro ao carregar estrutura:', error);
                alert('Erro ao carregar conte√∫do da mentoria. Verifique sua conex√£o.');
            }
        }

        // ============================================
        // RENDERIZA√á√ÉO
        // ============================================
        function renderizarModulos() {
            const mentoriaAtual = currentUser.mentoria;
            const moduleList = document.getElementById('moduleList');
            
            if (!estrutura || !estrutura[mentoriaAtual]) {
                moduleList.innerHTML = '<li style="color: var(--danger); padding: 1rem;">‚ùå Mentoria n√£o encontrada</li>';
                return;
            }

            const mentoriaData = estrutura[mentoriaAtual];
            allLessons = [];
            
            moduleList.innerHTML = mentoriaData.modules.map((module, moduleIndex) => {
                const lessonsHTML = module.lessons.map((lesson, lessonIndex) => {
                    const lessonId = `${mentoriaAtual}-${module.module_id}-${lesson.id}`;
                    allLessons.push({ ...lesson, moduleTitle: module.title, lessonId });
                    const isCompleted = completedLessons.includes(lessonId);
                    
                    return `
                        <li class="lesson-item ${isCompleted ? 'completed' : ''}" 
                            onclick="loadLesson('${mentoriaAtual}', ${moduleIndex}, ${lessonIndex})"
                            data-lesson-id="${lessonId}">
                            <span class="lesson-icon">${isCompleted ? '‚úÖ' : '‚ñ∂Ô∏è'}</span>
                            <span>${lesson.title}</span>
                            <span class="lesson-duration">${lesson.duration}</span>
                        </li>
                    `;
                }).join('');

                return `
                    <li class="module-item">
                        <div class="module-header" onclick="toggleModule(${moduleIndex})">
                            <span class="module-title">${module.title}</span>
                            <span class="module-icon" id="moduleIcon${moduleIndex}">‚ñº</span>
                        </div>
                        <ul class="lesson-list" id="lessonList${moduleIndex}">
                            ${lessonsHTML}
                        </ul>
                    </li>
                `;
            }).join('');

            document.getElementById('totalLessons').textContent = allLessons.length;
        }

        function toggleModule(moduleIndex) {
            const lessonList = document.getElementById('lessonList' + moduleIndex);
            const icon = document.getElementById('moduleIcon' + moduleIndex);
            
            lessonList.classList.toggle('show');
            icon.classList.toggle('open');
        }

        function loadLesson(mentoria, moduleIndex, lessonIndex) {
            const module = estrutura[mentoria].modules[moduleIndex];
            const lesson = module.lessons[lessonIndex];
            const lessonId = `${mentoria}-${module.module_id}-${lesson.id}`;

            currentLesson = {
                mentoria,
                moduleIndex,
                lessonIndex,
                lessonId,
                data: lesson,
                module: module
            };

            // Atualizar UI
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('lessonContent').style.display = 'block';
            
            document.getElementById('lessonTitle').textContent = lesson.title;
            document.getElementById('lessonModule').textContent = module.title;
            document.getElementById('lessonDuration').textContent = lesson.duration;
            document.getElementById('lessonVideoId').textContent = lesson.video_id;
            document.getElementById('lessonDescription').textContent = lesson.title; // Pode adicionar descri√ß√£o no JSON

            // Limpar v√≠deo anterior
            document.getElementById('videoContainer').innerHTML = `
                <div class="video-placeholder">
                    <div class="video-placeholder-icon">‚ñ∂Ô∏è</div>
                    <p>Clique em "Iniciar Aula" para come√ßar</p>
                </div>
            `;

            // Atualizar bot√µes
            const isCompleted = completedLessons.includes(lessonId);
            document.getElementById('btnComplete').textContent = isCompleted ? '‚úÖ Aula Conclu√≠da' : '‚úÖ Marcar como Conclu√≠da';
            document.getElementById('alertComplete').style.display = isCompleted ? 'block' : 'none';

            // Marcar aula ativa na sidebar
            document.querySelectorAll('.lesson-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-lesson-id="${lessonId}"]`).classList.add('active');

            // Controlar bot√µes anterior/pr√≥ximo
            document.getElementById('btnPrevious').disabled = (moduleIndex === 0 && lessonIndex === 0);
            
            const lastModule = estrutura[mentoria].modules.length - 1;
            const lastLesson = estrutura[mentoria].modules[lastModule].lessons.length - 1;
            document.getElementById('btnNext').disabled = (moduleIndex === lastModule && lessonIndex === lastLesson);

            // Carregar v√≠deo automaticamente
            carregarVideo(lesson.video_id);
        }

        async function carregarVideo(videoId) {
            try {
                // Chamada para API de v√≠deo tokenizado
                const response = await fetch(`/api/video-link?id=${videoId}`);
                const data = await response.json();
                
                if (data.status === 'sucesso' && data.secureUrl) {
                    document.getElementById('videoContainer').innerHTML = `
                        <iframe src="${data.secureUrl}" 
                                frameborder="0" 
                                allow="autoplay; fullscreen; picture-in-picture" 
                                allowfullscreen>
                        </iframe>
                    `;
                } else {
                    throw new Error('URL de v√≠deo n√£o dispon√≠vel');
                }
            } catch (error) {
                console.error('Erro ao carregar v√≠deo:', error);
                document.getElementById('videoContainer').innerHTML = `
                    <div class="video-placeholder">
                        <div class="video-placeholder-icon">‚ùå</div>
                        <p>Erro ao carregar v√≠deo. Tente novamente mais tarde.</p>
                    </div>
                `;
            }
        }

        // ============================================
        // PROGRESSO
        // ============================================
        function toggleComplete() {
            if (!currentLesson) return;

            const lessonId = currentLesson.lessonId;
            const index = completedLessons.indexOf(lessonId);

            if (index === -1) {
                completedLessons.push(lessonId);
                document.getElementById('btnComplete').textContent = '‚úÖ Aula Conclu√≠da';
                document.getElementById('alertComplete').style.display = 'block';
                
                // Atualizar √≠cone na sidebar
                const lessonItem = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                lessonItem.classList.add('completed');
                lessonItem.querySelector('.lesson-icon').textContent = '‚úÖ';
            } else {
                completedLessons.splice(index, 1);
                document.getElementById('btnComplete').textContent = '‚úÖ Marcar como Conclu√≠da';
                document.getElementById('alertComplete').style.display = 'none';
                
                const lessonItem = document.querySelector(`[data-lesson-id="${lessonId}"]`);
                lessonItem.classList.remove('completed');
                lessonItem.querySelector('.lesson-icon').textContent = '‚ñ∂Ô∏è';
            }

            localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
            atualizarProgresso();
        }

        function atualizarProgresso() {
            const completed = completedLessons.length;
            const total = allLessons.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('completedLessons').textContent = completed;
            document.getElementById('progressPercentage').textContent = percentage + '%';
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        // ============================================
        // NAVEGA√á√ÉO
        // ============================================
        function nextLesson() {
            if (!currentLesson) return;

            const { mentoria, moduleIndex, lessonIndex } = currentLesson;
            const currentModule = estrutura[mentoria].modules[moduleIndex];
            
            // Pr√≥xima aula no mesmo m√≥dulo
            if (lessonIndex < currentModule.lessons.length - 1) {
                loadLesson(mentoria, moduleIndex, lessonIndex + 1);
            } 
            // Primeira aula do pr√≥ximo m√≥dulo
            else if (moduleIndex < estrutura[mentoria].modules.length - 1) {
                loadLesson(mentoria, moduleIndex + 1, 0);
            }
        }

        function previousLesson() {
            if (!currentLesson) return;

            const { mentoria, moduleIndex, lessonIndex } = currentLesson;
            
            // Aula anterior no mesmo m√≥dulo
            if (lessonIndex > 0) {
                loadLesson(mentoria, moduleIndex, lessonIndex - 1);
            } 
            // √öltima aula do m√≥dulo anterior
            else if (moduleIndex > 0) {
                const prevModule = estrutura[mentoria].modules[moduleIndex - 1];
                loadLesson(mentoria, moduleIndex - 1, prevModule.lessons.length - 1);
            }
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                sessionStorage.clear();
                window.location.href = 'auth_system.html';
            }
        }
    </script>
</body>
</html>
