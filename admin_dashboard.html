<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Gest√£o Completa</title>

    <!-- Fontes do Design System (Sora para T√≠tulos, Inter para Corpo) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- FIREBASE IMPORTS CR√çTICOS (Firestore para Dados, Auth para Seguran√ßa) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Adicionado getDocs

        // Vari√°veis globais do Canvas (CR√çTICO para a inicializa√ß√£o)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        // 1. Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app); 
        window.db = getFirestore(app);
        window.appId = appId;
        
    </script>

    <style>
        /* VARI√ÅVEIS DO DESIGN SYSTEM (COMPLETO) */
        :root {
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-tertiary: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-quaternary: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            
            --color-dark: #0a0e27;
            --color-darker: #060919;
            --color-card: rgba(255, 255, 255, 0.03);
            --color-card-hover: rgba(255, 255, 255, 0.06);
            --color-text: #ffffff;
            --color-text-muted: #a0aec0;
            --color-accent: #667eea;
            --color-accent-secondary: #f5576c;
            
            --shadow-glow: 0 0 40px rgba(102, 126, 234, 0.3);
            --shadow-card: 0 20px 60px rgba(0, 0, 0, 0.3);

            --success: #43e97b;
            --danger: #f5576c;
            
            --section-padding: 2rem;
            --container-max-width: 1400px;
        }

        /* CONVERS√ÉO EST√âTICA COMPLETA */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--color-darker);
            color: var(--color-text);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            padding-top: 80px;
        }
        
        h1, h2, h3 {
            font-family: 'Sora', sans-serif;
            font-weight: 700;
        }

        header {
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 1.4rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-info {
            color: var(--color-text-muted);
            font-size: 0.9rem;
        }

        .logout-btn {
            background: var(--gradient-secondary);
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(245, 87, 108, 0.5);
        }

        .container {
            max-width: var(--container-max-width);
            margin: 0 auto;
            padding: var(--section-padding) 2rem;
            position: relative;
            z-index: 1;
        }

        /* TABS DE ADMIN */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--color-text-muted);
            padding: 0.75rem 0;
            cursor: pointer;
            font-size: 1.1rem;
            font-family: 'Sora', sans-serif;
            font-weight: 600;
            transition: color 0.3s, border-bottom 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--color-text);
            border-bottom: 3px solid var(--color-accent);
        }
        
        .tab-content {
            background: var(--color-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 400px;
        }
        
        /* Formul√°rios e Inputs */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            color: var(--color-text-muted);
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: var(--color-dark);
            color: var(--color-text);
            font-family: 'Inter', sans-serif;
        }
        
        .form-group textarea {
            resize: vertical;
        }

        .btn-save {
            background: var(--gradient-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-save:hover {
            transform: translateY(-1px);
        }

        /* Grid de Conte√∫do (Produtos) */
        #produtosList, #adminsList {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .produto-card, .admin-card {
            background: var(--color-card);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 5px solid var(--color-accent);
        }
        
        .produto-card h3, .admin-card h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--color-accent);
        }

        .produto-card p, .admin-card p {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            margin-bottom: 1rem;
        }
        
        .produto-tag {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--color-darker);
        }

        /* Mensagens de Status e Aviso */
        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 600;
            display: none;
        }
        
        .status-success {
            background-color: var(--success);
            color: var(--color-darker);
        }
        
        .status-error {
            background-color: var(--danger);
            color: white;
        }
        
        /* Efeitos de Fundo (Simetria com Home/Mentoria) */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(245, 87, 108, 0.1) 0%, transparent 50%);
            z-index: 0;
            animation: backgroundShift 20s ease infinite;
            pointer-events: none;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Painel Administrativo</h1>
        </div>
        <div class="header-right">
            <span class="user-info">Bem-vindo, <span id="welcomeName">Admin</span>!</span>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('gestaoConteudo')">Gest√£o de Conte√∫do</button>
            <button class="tab-btn" onclick="openTab('gestaoAdmin')">Gest√£o de Administradores</button>
        </div>

        <!-- Mensagem de Status Global -->
        <div id="statusMessage" class="status-message"></div>

        <!-- CONTE√öDO 1: GEST√ÉO DE CONTE√öDO (Mentorias, E-books, Imers√µes) -->
        <div id="gestaoConteudo" class="tab-content">
            <h2>Cadastro de Produto/Servi√ßo</h2>
            <form id="produtoForm" style="margin-bottom: 2rem;">
                <input type="hidden" id="produtoId" value="">
                
                <div class="form-group">
                    <label for="produtoNome">Nome do Produto/Mentoria (Ex: Mentoria SYNESIS)</label>
                    <input type="text" id="produtoNome" required>
                </div>
                <div class="form-group">
                    <label for="produtoTipo">Tipo (Ex: Mentoria, Ebook, Imers√£o)</label>
                    <select id="produtoTipo" required>
                        <option value="Mentoria">Mentoria</option>
                        <option value="Ebook">E-book</option>
                        <option value="Imers√£o">Imers√£o</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="produtoGradiente">Gradiente de Cor (Design System)</label>
                    <select id="produtoGradiente" required>
                        <option value="primary">Primary (Roxo-Azulado)</option>
                        <option value="secondary">Secondary (Rosa-Vermelho)</option>
                        <option value="tertiary">Tertiary (Azul Ciano)</option>
                        <option value="quaternary">Quaternary (Verde)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="produtoTag">Tag de Destaque (Ex: FOCO: Lideran√ßa)</label>
                    <input type="text" id="produtoTag" required>
                </div>
                <div class="form-group">
                    <label for="produtoDescricao">Descri√ß√£o Curta (M√°x. 150 caracteres para Card)</label>
                    <textarea id="produtoDescricao" rows="3" required></textarea>
                </div>

                <button type="submit" id="salvarBtn" class="btn-save">Salvar Produto</button>
                <button type="button" id="cancelarEdicaoBtn" class="logout-btn" style="margin-left: 1rem; display: none;" onclick="resetForm()">Cancelar Edi√ß√£o</button>
            </form>

            <h2 style="margin-top: 3rem;">Produtos Cadastrados</h2>
            <div id="produtosList">Carregando produtos...</div>
        </div>

        <!-- CONTE√öDO 2: GEST√ÉO DE ADMINISTRADORES (Novo e CR√çTICO) -->
        <div id="gestaoAdmin" class="tab-content" style="display:none;">
            <h2>Designar Novo Administrador</h2>
            <p style="color: var(--color-text-muted); margin-bottom: 1.5rem;">
                Para promover um usu√°rio, ele deve primeiro se **cadastrar** na √°rea restrita. Use o UID do usu√°rio (encontrado no console do Firebase) para designar acesso total.
            </p>
            <form id="adminForm" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <label for="adminUid">UID do Usu√°rio (Identificador √önico do Firebase)</label>
                    <input type="text" id="adminUid" placeholder="Ex: X9Y1Z..." required>
                </div>
                <div class="form-group">
                    <label for="adminNome">Nome do Administrador</label>
                    <input type="text" id="adminNome" placeholder="Ex: S√©rgio Tanigawa" required>
                </div>
                <button type="submit" class="btn-save" style="background: var(--gradient-quaternary);">Designar como Admin</button>
            </form>

            <h2 style="margin-top: 3rem;">Administradores Ativos</h2>
            <div id="adminsList">Carregando administradores...</div>
        </div>

    </div>

    <script type="module">
        // Imports e inicializa√ß√£o j√° definidos no bloco <script type="module"> inicial
        
        /* ----------------------------------------------------
           CONSTANTES FIRESTORE
           ---------------------------------------------------- */
        const PRODUTOS_COLLECTION = 'produtos';
        const ADMINS_COLLECTION = 'admins';
        
        function getProductsCollectionRef() {
            // Cole√ß√£o p√∫blica: todos veem as mentorias
            const path = `artifacts/${window.appId}/public/data/${PRODUTOS_COLLECTION}`;
            return firebase.firestore.collection(window.db, path);
        }
        
        function getAdminsCollectionRef() {
            // Cole√ß√£o p√∫blica: todos veem (para checagem de permiss√£o)
            const path = `artifacts/${window.appId}/public/data/${ADMINS_COLLECTION}`;
            return firebase.firestore.collection(window.db, path);
        }


        /* ----------------------------------------------------
           FUN√á√ïES DE LAYOUT GERAL
           ---------------------------------------------------- */
        
        function showStatus(message, isSuccess = true) {
            const box = document.getElementById('statusMessage');
            box.textContent = message;
            box.className = `status-message ${isSuccess ? 'status-success' : 'status-error'}`;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 5000);
        }
        window.showStatus = showStatus;

        window.logout = async function() {
            try {
                await firebase.auth.signOut(window.auth);
                sessionStorage.clear();
                window.location.replace('auth_system.html');
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                sessionStorage.clear();
                window.location.replace('auth_system.html');
            }
        };
        
        function openTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const btns = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(tab => tab.style.display = 'none');
            btns.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).style.display = 'block';
            document.querySelector(`.tab-btn[onclick*="${tabName}"]`).classList.add('active');

            if (tabName === 'gestaoConteudo') {
                 carregarProdutos();
            } else if (tabName === 'gestaoAdmin') {
                 carregarAdmins();
            }
        }
        window.openTab = openTab;

        /* ----------------------------------------------------
           GEST√ÉO DE PRODUTOS/CONTE√öDO (CRUD)
           ---------------------------------------------------- */
        
        window.carregarProdutos = function() {
            if (!window.db) return;

            const produtosRef = getProductsCollectionRef();
            const produtosList = document.getElementById('produtosList');
            produtosList.innerHTML = 'Carregando produtos do Firestore...';

            firebase.firestore.onSnapshot(produtosRef, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    produtosList.innerHTML = `<div style="grid-column: 1 / -1; color: var(--color-text-muted);">Nenhum produto cadastrado.</div>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    html += `
                    <div class="produto-card" style="border-left-color: var(--color-accent);">
                        <span class="produto-tag" style="background: var(--gradient-${data.gradiente}); color: var(--color-darker);">${data.tipo}</span>
                        <h3 style="background: var(--gradient-${data.gradiente}); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${data.nome}</h3>
                        <p>${data.tag}</p>
                        <div class="produto-actions">
                            <button class="btn-copy btn-save" onclick="preencherFormEdicao('${id}')">Editar</button>
                            <button class="logout-btn" style="background: var(--gradient-secondary);" onclick="excluirProduto('${id}', '${data.nome}')">Excluir</button>
                        </div>
                    </div>
                    `;
                });
                produtosList.innerHTML = html;
            }, (error) => {
                console.error("Erro ao ouvir produtos:", error);
                showStatus('Erro ao carregar lista de produtos.', false);
            });
        };

        // Salva ou Edita um produto
        document.getElementById('produtoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('produtoId').value || Date.now().toString(); // Usa ID existente ou gera novo
            
            const produtoData = {
                nome: document.getElementById('produtoNome').value,
                tipo: document.getElementById('produtoTipo').value,
                gradiente: document.getElementById('produtoGradiente').value,
                tag: document.getElementById('produtoTag').value,
                descricao: document.getElementById('produtoDescricao').value,
                dataCadastro: new Date().toISOString()
            };
            
            const submitBtn = document.getElementById('salvarBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = id.length > 15 ? 'Cadastrando...' : 'Salvando Edi√ß√£o...';

            try {
                const produtoRef = firebase.firestore.doc(getProductsCollectionRef(), id);
                await firebase.firestore.setDoc(produtoRef, produtoData, { merge: true });
                
                showStatus(id.length > 15 ? `‚úÖ Produto "${produtoData.nome}" cadastrado com sucesso!` : `‚úÖ Produto "${produtoData.nome}" editado com sucesso!`, true);
                resetForm();

            } catch (error) {
                console.error("Erro ao salvar produto:", error);
                showStatus('‚ùå Erro ao salvar produto. Verifique a conex√£o.', false);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Salvar Produto';
            }
        });

        // Exclui um produto
        window.excluirProduto = async function(id, nome) {
            // Substitui√ß√£o de window.confirm()
            if (!window.confirm(`Tem certeza que deseja excluir o produto "${nome}"?`)) return;
            
            try {
                const produtoRef = firebase.firestore.doc(getProductsCollectionRef(), id);
                await firebase.firestore.deleteDoc(produtoRef);
                showStatus(`‚úÖ Produto "${nome}" exclu√≠do com sucesso!`, true);
            } catch (error) {
                console.error("Erro ao excluir produto:", error);
                showStatus('‚ùå Erro ao excluir produto.', false);
            }
        };

        // Preenche o formul√°rio para edi√ß√£o
        window.preencherFormEdicao = function(id) {
            // L√≥gica para obter todos os dados do Firestore (melhor que tentar ler do card)
            const produtoRef = firebase.firestore.doc(getProductsCollectionRef(), id);
            
            firebase.firestore.getDoc(produtoRef).then(docSnapshot => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    
                    document.getElementById('produtoId').value = id;
                    document.getElementById('produtoNome').value = data.nome;
                    document.getElementById('produtoTipo').value = data.tipo;
                    document.getElementById('produtoGradiente').value = data.gradiente;
                    document.getElementById('produtoTag').value = data.tag;
                    document.getElementById('produtoDescricao').value = data.descricao;
                    
                    document.getElementById('salvarBtn').textContent = 'Atualizar Produto';
                    document.getElementById('cancelarEdicaoBtn').style.display = 'inline-block';
                    showStatus(`Modo Edi√ß√£o ativado para: ${data.nome}`, true);
                }
            }).catch(error => {
                console.error("Erro ao carregar dados para edi√ß√£o:", error);
                showStatus('Erro ao carregar dados para edi√ß√£o.', false);
            });
        };
        
        // Limpa o formul√°rio ap√≥s edi√ß√£o/cadastro
        function resetForm() {
            document.getElementById('produtoForm').reset();
            document.getElementById('produtoId').value = '';
            document.getElementById('salvarBtn').textContent = 'Salvar Produto';
            document.getElementById('cancelarEdicaoBtn').style.display = 'none';
        }
        window.resetForm = resetForm;


        /* ----------------------------------------------------
           GEST√ÉO DE ADMINISTRADORES (Escalabilidade)
           ---------------------------------------------------- */
        
        window.carregarAdmins = function() {
            if (!window.db) return;

            const adminsRef = getAdminsCollectionRef();
            const adminsList = document.getElementById('adminsList');
            adminsList.innerHTML = 'Carregando administradores do Firestore...';

            firebase.firestore.onSnapshot(adminsRef, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    adminsList.innerHTML = `<div style="grid-column: 1 / -1; color: var(--color-text-muted);">Nenhum administrador designado via UID.</div>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const uid = doc.id;
                    
                    html += `
                    <div class="admin-card">
                        <h3>${data.nome}</h3>
                        <p>UID: ${uid.slice(0, 10)}...</p>
                        <p style="color: var(--color-accent-secondary);">${data.email || 'N√£o Registrado'}</p>
                        <div class="produto-actions" style="margin-top: 1rem;">
                            <button class="logout-btn" style="background: var(--gradient-secondary);" onclick="removerAdmin('${uid}', '${data.nome}')">Remover Admin</button>
                        </div>
                    </div>
                    `;
                });
                adminsList.innerHTML = html;
            }, (error) => {
                console.error("Erro ao ouvir administradores:", error);
                showStatus('Erro ao carregar lista de administradores.', false);
            });
        };
        
        document.getElementById('adminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const uid = document.getElementById('adminUid').value.trim();
            const nome = document.getElementById('adminNome').value.trim();
            
            const adminData = {
                nome: nome,
                designadoPor: sessionStorage.getItem('userName'),
                dataDesignacao: new Date().toISOString()
            };
            
            if (uid.length < 20) {
                 showStatus('UID inv√°lido. Deve ser o identificador completo do Firebase.', false);
                 return;
            }

            try {
                const adminRef = firebase.firestore.doc(getAdminsCollectionRef(), uid);
                await firebase.firestore.setDoc(adminRef, adminData, { merge: true });
                
                showStatus(`‚úÖ Usu√°rio ${nome} designado como Administrador!`, true);
                document.getElementById('adminForm').reset();

            } catch (error) {
                console.error("Erro ao designar Admin:", error);
                showStatus('‚ùå Erro ao designar Administrador. Verifique se o UID est√° correto.', false);
            }
        });
        
        window.removerAdmin = async function(uid, nome) {
            // Substitui√ß√£o de window.confirm()
            if (!window.confirm(`Tem certeza que deseja remover as permiss√µes de administrador de "${nome}"?`)) return;

            try {
                const adminRef = firebase.firestore.doc(getAdminsCollectionRef(), uid);
                await firebase.firestore.deleteDoc(adminRef);
                showStatus(`‚úÖ Permiss√µes de Admin removidas para "${nome}". O usu√°rio agora √© Membro comum.`, true);
            } catch (error) {
                console.error("Erro ao remover Admin:", error);
                showStatus('‚ùå Erro ao remover Administrador.', false);
            }
        };

        /* ----------------------------------------------------
           GUARDA-CORPO DE SEGURAN√áA (ADMIN)
           ---------------------------------------------------- */
           
        // üõë NOVO FLUXO: PROMO√á√ÉO AUTOM√ÅTICA DO PRIMEIRO ADMIN 
        async function promoteInitialAdmin(user) {
            const adminsSnapshot = await firebase.firestore.getDocs(getAdminsCollectionRef());
            
            if (adminsSnapshot.empty) {
                // √â o primeiro usu√°rio a entrar, vamos promov√™-lo
                const adminData = {
                    nome: "Sergio Tanigawa", // Nome hardcoded para o primeiro admin
                    email: user.email,
                    dataDesignacao: new Date().toISOString(),
                    primeiroAdmin: true
                };
                
                const adminRef = firebase.firestore.doc(getAdminsCollectionRef(), user.uid);
                await firebase.firestore.setDoc(adminRef, adminData);

                // Atualiza a sess√£o e for√ßa o recarregamento
                sessionStorage.setItem('userType', 'admin');
                sessionStorage.setItem('userName', adminData.nome);
                
                showStatus(`‚úÖ Bem-vindo, Sergio Tanigawa! Voc√™ foi designado como o primeiro Administrador.`, true);
                
                // For√ßa o logout para o onAuthStateChanged recarregar as permiss√µes de Admin
                setTimeout(async () => {
                    await firebase.auth.signOut(window.auth);
                    window.location.replace('auth_system.html');
                }, 2000);
                
                return true; // Promovido
            }
            return false; // N√£o promovido
        }
           
        function checkAdminAuth() {
            // Se o Firebase ainda n√£o carregou, espera
            if (!window.auth) {
                 setTimeout(checkAdminAuth, 100); 
                 return;
            }

            // Listener de estado de autentica√ß√£o
            firebase.auth.onAuthStateChanged(window.auth, async (user) => {
                
                if (!user) {
                    // N√£o logado: Redireciona
                    window.location.replace('auth_system.html');
                    return;
                }
                
                const userType = sessionStorage.getItem('userType');
                const userName = sessionStorage.getItem('userName');
                
                // üõë Tenta Autopromo√ß√£o se for o primeiro
                if (userType !== 'admin') {
                     const promoted = await promoteInitialAdmin(user);
                     if (promoted) return; // Se promovido, o c√≥digo far√° logout e recarregar√°
                }

                // Verifica o acesso ap√≥s a tentativa de promo√ß√£o
                if (userType !== 'admin') {
                    showStatus('Acesso negado. Voc√™ n√£o possui permiss√µes de Administrador.', false);
                    setTimeout(() => {
                        window.location.replace('area_membros.html'); // Membro vai para sua √°rea
                    }, 1000);
                    return;
                }
                
                // Se for Admin, preenche a interface
                document.getElementById('welcomeName').textContent = userName || user.email.split('@')[0];
                
                // Carrega o conte√∫do default
                carregarProdutos();
            });
        }

        // ----------------------------------------------------
        // INICIALIZA√á√ÉO
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth(); // Inicia a verifica√ß√£o de seguran√ßa
        });
        
    </script>
</body>
</html>